apply plugin: 'konan'

konanArtifacts {
    library(project.name, targets: ["ios_arm64", "ios_x64", "macos_x64"]) {
        enableMultiplatform true
        artifactName project.name.replace('-', '_')
    }
    // TODO: THIS IS A WORKAROUND: Cannot do tests together with publishing in Kotlin/Native
    if (!rootProject.properties["publish"]) {
        program("${project.name}-test", targets: ["macos_x64"]) {
            srcDir 'src/test/kotlin'
            commonSourceSet 'test'
            libraries {
                artifact project.name
            }
            extraOpts '-tr'
        }
    }
}

dependencies {
    expectedBy project(':atomicfu-common')
}

task test(dependsOn: run)

// TODO: THIS IS A WORKAROUND: Cannot do tests together with publishing in Kotlin/Native
if (rootProject.properties["publish"]) {
    publishToMavenLocal.dependsOn(build)
}

